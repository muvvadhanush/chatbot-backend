<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Admin | AI Governance</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="/admin.css">
</head>

<body>

    <!-- TOP NAVBAR -->
    <nav class="navbar-top">
        <div class="brand">
            <span class="material-symbols-outlined" style="color: var(--primary);">neurology</span>
            <span class="brand-name">Neural Bot</span>
        </div>

        <div class="nav-menu">
            <a href="#" id="navDashboard" class="nav-item active">
                <span class="material-symbols-outlined">dashboard</span>
                <span class="nav-label">Dashboard</span>
            </a>
            <a href="#" id="navConnections" class="nav-item">
                <span class="material-symbols-outlined">hub</span>
                <span class="nav-label">Connections</span>
                <span class="status-badge success">12</span>
            </a>
            <a href="#" id="navAnalytics" class="nav-item">
                <span class="material-symbols-outlined">analytics</span>
                <span class="nav-label">Analytics</span>
            </a>
            <a href="#" id="navSettings" class="nav-item">
                <span class="material-symbols-outlined">settings</span>
                <span class="nav-label">Settings</span>
            </a>
        </div>

        <div class="navbar-center">
            <div class="search-bar">
                <span class="material-symbols-outlined">search</span>
                <input type="text" placeholder="Search...">
            </div>
        </div>

        <div class="nav-actions">
            <div class="system-status">
                <span class="status-indicator"></span>
                <span class="status-text">System Active</span>
            </div>
            <button id="btnThemeToggle" class="btn-theme-nav">
                <span class="material-symbols-outlined" id="themeIcon">light_mode</span>
            </button>
            <a href="#" id="btnLogout" class="nav-item logout">
                <span class="material-symbols-outlined">logout</span>
                <span class="nav-label">Logout</span>
            </a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView">
            <!-- Legacy Header Removed -->

            <!-- METRICS -->
            <div class="metrics-grid">
                <div class="neu-card">
                    <div class="metric-label">Total Connections</div>
                    <div id="metricConnections" class="metric-value">-</div>
                    <div class="text-success" style="font-size: 0.9rem;">Live</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Active Conversations</div>
                    <div id="metricConversations" class="metric-value">-</div>
                    <div class="text-success" style="font-size: 0.9rem;">Live</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Knowledge Sources</div>
                    <div id="metricKnowledge" class="metric-value">-</div>
                    <div class="text-secondary" style="font-size: 0.9rem;">Across all bots</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Platform Health</div>
                    <div id="metricHealth" class="metric-value">-</div>
                    <div id="metricHealthLabel" class="text-success" style="font-size: 0.9rem;">Stable</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Estimated API Cost</div>
                    <div id="metricCost" class="metric-value">-</div>
                    <div class="text-secondary" style="font-size: 0.9rem;">Current Month (est)</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Knowledge Gaps</div>
                    <div id="metricGaps" class="metric-value">-</div>
                    <div id="metricGapsLabel" class="text-success" style="font-size: 0.9rem;">0 Pending</div>
                </div>
            </div>

            <!-- CONNECTIONS -->
            <section>
                <div class="header" style="margin-bottom: 24px;">
                    <h2 style="font-size: 1.4rem;">All Connections</h2>
                    <button id="btnNewConnection" class="btn-neu">
                        <span class="material-symbols-outlined">add</span>
                        New Connection
                    </button>
                </div>

                <div id="connectionsList" class="connections-grid">
                    <!-- Javascript will populate this -->
                    <div class="loading">Loading connections...</div>
                </div>
            </section>
        </div>

        <!-- DETAILS VIEW (Tabbed Interface) -->
        <div id="detailsView" class="hidden">
            <header class="header">
                <div class="page-title">
                    <button id="btnBackToDash" class="btn-icon" style="margin-right: 10px;">
                        <span class="material-symbols-outlined">arrow_back</span>
                    </button>
                    <div id="detailAvatar" class="avatar-circle"
                        style="width:40px; height:40px; font-size:1.2rem; margin-right: 15px;">A</div>
                    <div>
                        <h1 id="detailTitle">Connection Details</h1>
                        <p id="detailSubtitle">Manage knowledge and settings.</p>
                    </div>
                </div>
            </header>

            <!-- TABS -->
            <div class="tabs-container">
                <div class="tab-header">
                    <div class="tab-item active" data-tab="tabTune">
                        <span class="material-symbols-outlined">tune</span> Tune
                    </div>
                    <div class="tab-item" data-tab="tabTest">
                        <span class="material-symbols-outlined">chat</span> Test
                    </div>
                    <div class="tab-item" data-tab="tabWidget">
                        <span class="material-symbols-outlined">widgets</span> Widget
                    </div>
                    <div class="tab-item" data-tab="tabCustomize">
                        <span class="material-symbols-outlined">palette</span> Customize
                    </div>
                    <div class="tab-item" data-tab="tabIntegrations">
                        <span class="material-symbols-outlined">hub</span> Integrations
                    </div>
                    <div class="tab-item" data-tab="tabButtons">
                        <span class="material-symbols-outlined">smart_button</span> Buttons
                    </div>
                </div>

                <!-- TAB CONTENT: TUNE -->
                <div id="tabTune" class="tab-content active">
                    <div class="two-col-grid">
                        <section>
                            <h2 class="section-title">Business Details</h2>
                            <div class="neu-card">
                                <div class="input-group">
                                    <label>Assistant Name</label>
                                    <input type="text" id="tuneName" class="input-neu">
                                </div>
                                <div class="input-group">
                                    <label>System Prompt (Instructions)</label>
                                    <textarea id="tunePrompt" class="input-neu" rows="6"
                                        placeholder="You are a helpful assistant..."></textarea>
                                </div>
                                <button id="btnSaveTune" class="btn-neu" style="width: 100%; color: var(--success);">
                                    <span class="material-symbols-outlined">save</span> Save Tunings
                                </button>
                            </div>

                            <h2 class="section-title" style="margin-top: 20px;">AI Behavior</h2>
                            <div class="neu-card">
                                <div class="input-group">
                                    <label>Assistant Tone</label>
                                    <select id="tuneTone" class="input-neu">
                                        <option value="Professional">Professional</option>
                                        <option value="Friendly">Friendly</option>
                                        <option value="Sales-Oriented">Sales-Oriented</option>
                                        <option value="Technical">Technical</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Response Length (Max Tokens)</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" id="tuneLength" min="50" max="800" step="50" value="400"
                                            class="range-neu">
                                        <span id="valTuneLength" style="font-weight: 600; min-width: 40px;">400</span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Confidence Threshold</label>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="range" id="tuneThreshold" min="0" max="1" step="0.1" value="0.7"
                                            class="range-neu">
                                        <span id="valTuneThreshold"
                                            style="font-weight: 600; min-width: 40px;">0.7</span>
                                    </div>
                                </div>
                                <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 10px;">
                                    Adjust how much knowledge similarity is required for the AI to attempt an answer.
                                </p>
                            </div>

                            <h2 class="section-title" style="margin-top: 20px;">Knowledge Base</h2>
                            <div class="neu-card">
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">
                                    Manage your indexed content.
                                </p>
                                <button id="btnRefreshExtract" class="btn-neu" style="width: 100%;">
                                    <span class="material-symbols-outlined">refresh</span> re-Scan Website
                                </button>
                                <div id="knowledgeList" class="review-list" style="margin-top: 15px;">
                                    <!-- Dynamic Content -->
                                </div>
                            </div>
                        </section>

                        <section>
                            <h2 class="section-title">Missed Questions</h2>
                            <div id="missedList" class="review-list">
                                <div class="empty-state">No missed questions yet.</div>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- TAB CONTENT: TEST -->
                <div id="tabTest" class="tab-content">
                    <div class="chat-preview" style="height: 600px;">
                        <div class="chat-messages" id="testTabMessages">
                            <div class="msg-bot">Hello! I'm ready to help.</div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" id="inpTestTabChat" placeholder="Type a message..." class="input-neu">
                            <button id="btnSendTestTabChat" class="btn-icon">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB CONTENT: WIDGET -->
                <div id="tabWidget" class="tab-content">
                    <div class="two-col-grid">
                        <section>
                            <h2 class="section-title">Installation</h2>
                            <div class="neu-card">
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">
                                    Add this code to your website's <code>&lt;head&gt;</code> tag.
                                </p>
                                <div class="code-block" id="snippetView"></div>
                                <button id="btnCopySnippetView" class="btn-neu" style="width: 100%; margin-top: 10px;">
                                    <span class="material-symbols-outlined">content_copy</span> Copy Code
                                </button>
                            </div>
                        </section>
                        <section>
                            <h2 class="section-title">Preview</h2>
                            <div class="neu-card"
                                style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--bg-body);">
                                <p style="color: var(--text-tertiary);">Widget Preview Placeholder</p>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- TAB CONTENT: CUSTOMIZE -->
                <div id="tabCustomize" class="tab-content">
                    <section style="max-width: 600px;">
                        <h2 class="section-title">Appearance</h2>
                        <div class="neu-card">
                            <div class="input-group">
                                <label>Widget Title</label>
                                <input type="text" id="cfgTitle" class="input-neu" placeholder="AI Assistant">
                            </div>
                            <div class="input-group">
                                <label>Welcome Message</label>
                                <input type="text" id="cfgWelcome" class="input-neu" placeholder="Hi! How can I help?">
                            </div>

                            <div class="two-col-grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div class="input-group">
                                    <label>Brand Color</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="color" id="cfgColor" value="#4f46e5"
                                            style="height: 40px; width: 60px; border: none; background: none; cursor: pointer;">
                                        <span id="cfgColorVal">#4f46e5</span>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Auto-Open (sec)</label>
                                    <input type="number" id="cfgTimer" class="input-neu" min="0"
                                        placeholder="0 (Disabled)">
                                </div>
                                <div class="input-group">
                                    <label>Bot Avatar URL (Optional)</label>
                                    <input type="text" id="cfgAvatar" class="input-neu" placeholder="https://...">
                                </div>
                            </div>

                            <button id="btnSaveConfig" class="btn-neu"
                                style="width: 100%; margin-top: 15px; color: var(--success);">
                                <span class="material-symbols-outlined">save</span> Save Appearance
                            </button>
                        </div>
                    </section>
                </div>

                <!-- TAB CONTENT: INTEGRATIONS -->
                <div id="tabIntegrations" class="tab-content">
                    <div class="two-col-grid">
                        <section>
                            <h2 class="section-title">Enterprise Connectors</h2>
                            <div class="neu-card">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2111/2111615.png" width="32"
                                        alt="Slack">
                                    <div>
                                        <h3 style="margin-bottom: 2px;">Slack Notifications</h3>
                                        <p style="font-size: 0.8rem; color: var(--text-tertiary);">Send knowledge gaps
                                            and escalations to a Slack channel.</p>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label>Incoming Webhook URL</label>
                                    <input type="password" id="slackWebhook" class="input-neu"
                                        placeholder="https://hooks.slack.com/services/...">
                                </div>
                                <button id="btnSaveSlack" class="btn-neu" style="width: 100%; color: var(--success);">
                                    <span class="material-symbols-outlined">save</span> Save Slack Config
                                </button>
                            </div>

                            <div class="neu-card" style="margin-top: 20px; opacity: 0.6; filter: grayscale(1);">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <img src="https://cdn-icons-png.flaticon.com/512/5968/5968852.png" width="32"
                                        alt="Salesforce">
                                    <div>
                                        <h3 style="margin-bottom: 2px;">Salesforce CRM (Coming Soon)</h3>
                                        <p style="font-size: 0.8rem;">Sync leads and feedback directly to your CRM.</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section>
                            <h2 class="section-title">Workflow Actions</h2>
                            <div class="neu-card">
                                <div class="input-group">
                                    <label>Action Type</label>
                                    <select id="actionType" class="input-neu">
                                        <option value="NONE">No Action</option>
                                        <option value="WEBHOOK">Generic Webhook</option>
                                        <option value="EMAIL">Email Alert</option>
                                        <option value="SLACK">Slack Message</option>
                                    </select>
                                </div>
                                <p style="font-size: 0.8rem; color: var(--text-tertiary);">This action triggers when a
                                    user completes a guided flow.</p>
                                <button id="btnSaveAction" class="btn-neu"
                                    style="width: 100%; margin-top: 20px; color: var(--success);">
                                    <span class="material-symbols-outlined">save</span> Save Action Policy
                                </button>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- TAB CONTENT: BUTTONS -->
                <div id="tabButtons" class="tab-content">
                    <div class="two-col-grid">
                        <section>
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <h2 class="section-title">Button Sets</h2>
                                <button class="btn-neu" onclick="showButtonEditor()" style="color:var(--accent);">
                                    <span class="material-symbols-outlined">add</span> New
                                </button>
                            </div>
                            <div id="buttonSetsList" class="btn-sets-list">
                                <div class="empty-state"
                                    style="text-align:center;padding:40px;color:var(--text-tertiary);">
                                    <span class="material-symbols-outlined"
                                        style="font-size:48px;opacity:0.3;">smart_button</span>
                                    <p style="margin-top:12px;">No button sets yet. Create one to add interactive
                                        buttons to your chatbot.</p>
                                </div>
                            </div>
                        </section>
                        <section>
                            <h2 class="section-title">Live Preview</h2>
                            <div class="neu-card" id="buttonPreviewPanel">
                                <div
                                    style="background:linear-gradient(135deg,#f0f0ff,#fff);border-radius:16px;padding:16px;min-height:120px;position:relative;">
                                    <div
                                        style="background:#fff;padding:10px 14px;border-radius:14px;font-size:13px;color:#374151;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:inline-block;max-width:80%;">
                                        How can I help you today?
                                    </div>
                                    <div id="previewBtnsContainer"
                                        style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;"></div>
                                </div>
                                <p
                                    style="font-size:0.75rem;color:var(--text-tertiary);margin-top:10px;text-align:center;">
                                    This preview shows how buttons appear in the widget.
                                </p>
                            </div>
                        </section>
                    </div>

                    <!-- BUTTON EDITOR DIALOG -->
                    <div id="buttonEditorDialog" class="btn-editor-dialog hidden">
                        <div class="btn-editor-overlay"></div>
                        <div class="btn-editor-content">
                            <div class="btn-editor-header">
                                <h3 id="btnEditorTitle">Create Button Set</h3>
                                <button class="btn-icon" onclick="hideButtonEditor()">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                            <div class="btn-editor-body">
                                <div class="input-group">
                                    <label>Set Name</label>
                                    <input type="text" id="btnSetName" class="input-neu"
                                        placeholder="e.g. Welcome Buttons" maxlength="100">
                                </div>
                                <div style="display:flex;gap:16px;">
                                    <div class="input-group" style="flex:1;">
                                        <label>Trigger Type</label>
                                        <select id="btnTriggerType" class="input-neu" onchange="toggleTriggerValue()">
                                            <option value="MANUAL">Manual</option>
                                            <option value="WELCOME">Welcome (1st message)</option>
                                            <option value="KEYWORD">Keyword Match</option>
                                            <option value="FALLBACK">Low Confidence Fallback</option>
                                        </select>
                                    </div>
                                    <div class="input-group" style="flex:1;">
                                        <label>Quick Reply</label>
                                        <label class="toggle-label">
                                            <input type="checkbox" id="btnQuickReply">
                                            <span style="font-size:0.8rem;color:var(--text-secondary);">Disappear after
                                                click</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="triggerValueGroup" class="input-group hidden">
                                    <label>Keywords (comma-separated)</label>
                                    <input type="text" id="btnTriggerValue" class="input-neu"
                                        placeholder="pricing, plans, cost">
                                </div>

                                <h4 style="margin-top:16px;margin-bottom:8px;">Buttons <span id="btnCountBadge"
                                        style="font-size:0.75rem;color:var(--text-tertiary);">(0/5)</span></h4>
                                <div id="buttonRowsContainer"></div>
                                <button class="btn-neu" id="btnAddRow" onclick="addButtonRow()"
                                    style="width:100%;margin-top:8px;color:var(--accent);">
                                    <span class="material-symbols-outlined">add</span> Add Button
                                </button>
                            </div>
                            <div class="btn-editor-footer">
                                <button class="btn-neu" onclick="hideButtonEditor()">Cancel</button>
                                <button class="btn-neu" id="btnSaveSet" onclick="saveButtonSet()"
                                    style="color:var(--success);">
                                    <span class="material-symbols-outlined">save</span> Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ANALYTICS VIEW -->
        <div id="analyticsView" class="hidden">
            <header class="header">
                <div class="page-title">
                    <h1>Performance Analytics</h1>
                    <p>Insights into your chatbot's conversations and engagement.</p>
                </div>
                <div class="user-profile">
                    <button class="btn-neu" onclick="loadAnalyticsData()">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                </div>
            </header>

            <div class="metrics-grid">
                <div class="neu-card">
                    <div class="metric-label">Total Conversations</div>
                    <div id="anaTotalConvs" class="metric-value">-</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Avg. Messages/Chat</div>
                    <div id="anaAvgMsg" class="metric-value">-</div>
                </div>
                <div class="neu-card">
                    <div class="metric-label">Avg. Confidence</div>
                    <div id="anaAvgConf" class="metric-value">-</div>
                </div>
            </div>

            <div class="two-col-grid" style="margin-top: 24px;">
                <div class="neu-card">
                    <h3>Conversation Volume</h3>
                    <div
                        style="height: 300px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.02); border-radius: 8px;">
                        <p style="color: var(--text-tertiary);">Chart Placeholder (Volume)</p>
                    </div>
                </div>
                <div class="neu-card">
                    <h3>Topic Distribution</h3>
                    <div
                        style="height: 300px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.02); border-radius: 8px;">
                        <p style="color: var(--text-tertiary);">Chart Placeholder (Topics)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="hidden">
            <header class="header">
                <div class="page-title">
                    <h1>Global Settings</h1>
                    <p>Manage account and platform configurations.</p>
                </div>
            </header>

            <div class="neu-card" style="max-width: 800px;">
                <h2 class="section-title">Account</h2>
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" value="admin@example.com" class="input-neu" disabled>
                </div>
                <div class="input-group">
                    <label>API Key (Master)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="password" value="sk_live_master_key_hidden" class="input-neu" disabled>
                        <button class="btn-neu">Reveal</button>
                    </div>
                </div>

                <h2 class="section-title" style="margin-top: 30px;">Platform Defaults</h2>
                <div class="input-group">
                    <label>Default Model</label>
                    <select class="input-neu">
                        <option>GPT-4o (Recommended)</option>
                        <option>GPT-3.5 Turbo</option>
                        <option>Claude 3.5 Sonnet</option>
                    </select>
                </div>

                <h2 class="section-title" style="margin-top: 30px;">Team</h2>
                <p style="color: var(--text-secondary); margin-bottom: 10px;">User management is disabled in this
                    version.</p>

                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn-neu primary">Save Changes</button>
                </div>
            </div>
        </div>

    </main>

    <!-- NEW CONNECTION WORKFLOW (Modal) -->
    <div id="workflowContainer" class="workflow-container">
        <div class="workflow-modal modal-content" style="width: 800px; max-width: 95%;">

            <!-- Header & Progress Sticky Section -->
            <div style="padding: 24px 24px 0; background: var(--bg-body); z-index: 10;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="font-size: 1.5rem;">New AI Connection</h2>
                        <p style="color:var(--text-secondary); font-size:0.9rem;">Follow the steps to launch your
                            enterprise chatbot.</p>
                    </div>
                    <button id="btnCloseWorkflow" class="btn-icon">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="step-indicator" style="margin-bottom: 20px;">
                    <div class="step-dot active" id="dotStep1">1</div>
                    <div class="step-dot" id="dotStep2">2</div>
                    <div class="step-dot" id="dotStep3">3</div>
                    <div class="step-dot" id="dotStep4">4</div>
                    <div class="step-dot" id="dotStep5">5</div>
                    <div class="step-dot" id="dotStep6">6</div>
                </div>
            </div>

            <div class="modal-body">


                <!-- STEP 1: CONNECT WEBSITE -->
                <div id="step1" class="workflow-step active">
                    <div class="two-col-grid" style="grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Left Column: Create Identity -->
                        <div>
                            <h3 style="margin-bottom: 5px;">Connect Your Website</h3>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 20px;">
                                Name your AI assistant and we'll generate the integration code.
                            </p>

                            <div class="input-group">
                                <label style="font-weight: 600;">Connection Name <span
                                        style="color: var(--error);">*</span></label>
                                <input type="text" id="inpSiteName" class="input-neu"
                                    placeholder="e.g. Acme Corp Support Bot" maxlength="64">
                                <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 4px;">
                                    This is how your bot appears in the admin panel.
                                </p>
                            </div>

                            <button id="btnCreateIdentity" class="btn-neu"
                                style="width: 100%; color: var(--accent); margin-top: 15px; padding: 14px;">
                                <span class="material-symbols-outlined">bolt</span>
                                Generate Connection
                            </button>
                        </div>

                        <!-- Right Column: Install & Verify -->
                        <div id="colConnect" style="opacity: 0.4; pointer-events: none; transition: all 0.3s;">
                            <h3 style="margin-bottom: 5px;">Install Widget</h3>
                            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 20px;">
                                Add this snippet to your website's <code>&lt;head&gt;</code> tag.
                            </p>

                            <!-- Snippet Display -->
                            <div class="code-block" id="codeSnippet"
                                style="min-height: 80px; font-size: 0.75rem; background: var(--bg-elevated); padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; white-space: pre-wrap; word-break: break-all; border: 1px solid var(--border-subtle);">
                                &lt;!-- Snippet appears after creation --&gt;
                            </div>
                            <button id="btnCopyCode" class="btn-neu"
                                style="width: 100%; margin-top: 8px; margin-bottom: 16px;">
                                <span class="material-symbols-outlined">content_copy</span> Copy Snippet
                            </button>

                            <!-- Handshake Status -->
                            <div class="neu-card" id="handshakeCard" style="text-align: center; padding: 20px;">
                                <div id="handshakeIcon" style="margin-bottom: 8px;">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 32px; color: var(--text-tertiary);">
                                        pending
                                    </span>
                                </div>
                                <div id="verifyStatus" style="font-size: 0.9rem; font-weight: 600; margin-bottom: 4px;">
                                    Waiting for creation…
                                </div>
                                <div id="handshakeHint" style="font-size: 0.8rem; color: var(--text-tertiary);">
                                    Your widget will check in automatically once installed.
                                </div>
                                <div id="handshakeTimer"
                                    style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 8px;">
                                </div>

                                <!-- Retry Button (hidden initially) -->
                                <button id="btnRetryHandshake" class="btn-neu hidden"
                                    style="width: 100%; margin-top: 12px; color: var(--warning);">
                                    <span class="material-symbols-outlined">refresh</span> Regenerate Key & Retry
                                </button>
                            </div>

                            <!-- Next Button (blocked until handshake) -->
                            <button id="btnStep1Next" class="btn-neu"
                                style="width: 100%; margin-top: 16px; padding: 14px; color: var(--primary);" disabled>
                                <span class="material-symbols-outlined">arrow_forward</span>
                                Next: Train Knowledge Base
                            </button>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: LET AI LEARN -->
                <div id="step2" class="workflow-step">
                    <h3 style="margin-bottom: 6px;">
                        <span class="material-symbols-outlined"
                            style="vertical-align: middle; color: var(--primary);">school</span>
                        Let AI Learn
                    </h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                        Provide your website URL so the AI can discover and learn from your content.
                    </p>

                    <div class="two-col-grid" style="gap: 24px; align-items: start;">
                        <!-- LEFT: Input + Controls -->
                        <div>
                            <div class="neu-card" style="padding: 24px;">
                                <label style="font-weight: 600; margin-bottom: 8px; display: block;">Website URL</label>
                                <input type="url" id="inpLearnUrl" class="input-neu"
                                    placeholder="https://yourwebsite.com" style="margin-bottom: 16px; width: 100%;">

                                <button id="btnStartLearn" class="primary"
                                    style="width: 100%; padding: 14px; font-weight: 600;">
                                    <span class="material-symbols-outlined"
                                        style="vertical-align: middle; margin-right: 6px;">rocket_launch</span>
                                    Start Learning
                                </button>

                                <!-- Phase Indicator -->
                                <div id="learnPhaseCard" class="hidden"
                                    style="margin-top: 20px; padding: 16px; border-radius: 12px; background: var(--bg-secondary); text-align: center;">
                                    <div id="learnPhaseIcon" style="margin-bottom: 8px;">
                                        <span class="material-symbols-outlined fa-spin"
                                            style="font-size: 32px; color: var(--primary);">progress_activity</span>
                                    </div>
                                    <p id="learnPhaseText" style="font-weight: 600; margin-bottom: 4px;">Discovering
                                        pages...</p>
                                    <p id="learnPhaseHint" style="font-size: 0.8rem; color: var(--text-tertiary);">This
                                        may
                                        take 30–60 seconds depending on site size.</p>
                                </div>

                                <!-- Retry Button (hidden by default) -->
                                <button id="btnRetryLearn" class="btn-neu hidden"
                                    style="width: 100%; margin-top: 12px; color: var(--warning);">
                                    <span class="material-symbols-outlined"
                                        style="vertical-align: middle;">refresh</span>
                                    Retry Learning
                                </button>
                            </div>

                            <!-- Manual methods toggle -->
                            <details style="margin-top: 16px;" class="neu-card" id="manualLearnMethods">
                                <summary
                                    style="cursor: pointer; font-weight: 600; padding: 12px; color: var(--text-secondary);">
                                    <span class="material-symbols-outlined"
                                        style="vertical-align: middle; font-size: 18px;">tune</span>
                                    Manual Methods (File / Paste)
                                </summary>
                                <div style="padding: 0 16px 16px;">
                                    <!-- File Upload -->
                                    <div style="margin-bottom: 16px;">
                                        <label style="font-weight: 600; font-size: 0.85rem;">Upload File (PDF, TXT,
                                            DOCX)</label>
                                        <input type="file" id="inpFile" class="hidden" accept=".pdf,.txt,.docx">
                                        <button onclick="document.getElementById('inpFile').click()" class="btn-neu"
                                            style="margin-top: 6px; width: 100%;">
                                            <span class="material-symbols-outlined"
                                                style="vertical-align: middle;">upload_file</span> Select File
                                        </button>
                                        <div id="fileNameDisplay"
                                            style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 4px;">No
                                            file
                                            selected</div>
                                        <button id="btnUploadFile" class="primary" disabled
                                            style="width: 100%; margin-top: 8px; padding: 10px;">Upload &
                                            Extract</button>
                                    </div>
                                    <!-- Manual Paste -->
                                    <div>
                                        <label style="font-weight: 600; font-size: 0.85rem;">Paste Knowledge</label>
                                        <input type="text" id="inpPasteTitle" class="input-neu"
                                            placeholder="Title (e.g. Return Policy)" style="margin-top: 6px;">
                                        <textarea id="inpPasteContent" class="input-neu" rows="4"
                                            placeholder="Paste content..." style="margin-top: 8px;"></textarea>
                                        <button id="btnSavePaste" class="primary"
                                            style="width: 100%; margin-top: 8px; padding: 10px;">Save & Extract</button>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- RIGHT: Learning Dashboard -->
                        <div id="learnDashboard" style="opacity: 0.4; pointer-events: none;">
                            <div class="neu-card" style="padding: 24px;">
                                <h4 style="margin-bottom: 16px; color: var(--text-primary);">
                                    <span class="material-symbols-outlined"
                                        style="vertical-align: middle; color: var(--primary);">monitoring</span>
                                    Learning Progress
                                </h4>

                                <!-- Stats Grid -->
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                                    <div
                                        style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                                        <span id="statDiscovered"
                                            style="font-size: 1.8rem; font-weight: 700; color: var(--primary);">0</span>
                                        <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px;">
                                            Pages
                                            Found</p>
                                    </div>
                                    <div
                                        style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                                        <span id="statIndexed"
                                            style="font-size: 1.8rem; font-weight: 700; color: var(--success, #22c55e);">0</span>
                                        <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px;">
                                            Pages
                                            Learned</p>
                                    </div>
                                    <div
                                        style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                                        <span id="statFailed"
                                            style="font-size: 1.8rem; font-weight: 700; color: var(--error, #ef4444);">0</span>
                                        <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px;">
                                            Failed
                                        </p>
                                    </div>
                                    <div
                                        style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                                        <span id="statKnowledge"
                                            style="font-size: 1.8rem; font-weight: 700; color: var(--accent);">0</span>
                                        <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 2px;">
                                            Knowledge Items</p>
                                    </div>
                                </div>

                                <!-- Coverage Bar -->
                                <label
                                    style="font-size: 0.8rem; font-weight: 600; color: var(--text-secondary);">Coverage</label>
                                <div
                                    style="background: var(--bg-tertiary, #1a1a2e); border-radius: 8px; height: 10px; margin-top: 6px; overflow: hidden;">
                                    <div id="coverageFill"
                                        style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent)); border-radius: 8px; transition: width 0.6s ease;">
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                                    <span id="coveragePercent"
                                        style="font-size: 0.8rem; font-weight: 700; color: var(--primary);">0%</span>
                                    <span style="font-size: 0.7rem; color: var(--text-tertiary);">Min 30%
                                        required</span>
                                </div>

                                <!-- Threshold Indicators -->
                                <div id="thresholdIndicators" style="margin-top: 16px; font-size: 0.8rem;">
                                    <div id="threshPages"
                                        style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; color: var(--text-tertiary);">
                                        <span class="material-symbols-outlined"
                                            style="font-size: 16px;">radio_button_unchecked</span>
                                        <span>Minimum 3 pages learned</span>
                                    </div>
                                    <div id="threshCoverage"
                                        style="display: flex; align-items: center; gap: 6px; color: var(--text-tertiary);">
                                        <span class="material-symbols-outlined"
                                            style="font-size: 16px;">radio_button_unchecked</span>
                                        <span>Minimum 30% coverage</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Extraction Review Panel (Fix 4) -->
                            <div id="extractionReviewPanel" style="display: none; margin-top: 18px;">
                                <h4
                                    style="margin-bottom: 10px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 18px; color: var(--primary);">checklist</span>
                                    Extracted Data — Review
                                    <span id="extractionPendingBadge" class="risk-badge medium"
                                        style="font-size: 0.65rem; padding: 2px 8px;">0 PENDING</span>
                                </h4>
                                <div id="extractionReviewList"
                                    style="max-height: 240px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Dynamically populated extraction cards -->
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Next Button (blocked) -->
                <div style="text-align: center; margin-top: 24px;">
                    <button id="btnStep2Next" class="btn-neu" disabled
                        style="padding: 14px 36px; font-weight: 600; font-size: 1rem; color: var(--primary); opacity: 0.5;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward</span>
                        Next: Tune Behavior
                    </button>
                </div>
            </div>


            <!-- STEP 3: BRAND DETECTION & BEHAVIOR -->
            <div id="step3" class="workflow-step">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h3 style="margin-bottom: 6px;">
                            <span class="material-symbols-outlined"
                                style="vertical-align: middle; color: var(--primary); margin-right: 8px;">fingerprint</span>
                            Brand Identity & Assets
                        </h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">
                            Configure your chatbot's visual identity and personality traits.
                        </p>
                    </div>
                </div>

                <!-- 3a. BRAND ASSETS (Favicon/Logo) -->
                <div class="neu-card" style="margin-bottom: 32px; padding: 24px;">
                    <h4 style="margin-top: 0; margin-bottom: 16px; font-size: 1rem;">
                        <span class="material-symbols-outlined"
                            style="vertical-align: middle; margin-right: 8px; font-size: 20px;">image</span>
                        Brand Assets
                    </h4>

                    <div style="display: flex; align-items: center; gap: 24px;">
                        <!-- Preview -->
                        <div style="text-align: center;">
                            <div
                                style="width: 64px; height: 64px; border-radius: 12px; background: var(--bg-body); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; margin-bottom: 8px; overflow: hidden;">
                                <img id="imgFaviconPreview" src="/favicon.ico" alt="Favicon"
                                    style="width: 32px; height: 32px; object-fit: contain;">
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Favicon</div>
                        </div>

                        <!-- Actions -->
                        <div style="flex: 1;">
                            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                                <button class="btn-neu" onclick="document.getElementById('inpFaviconUpload').click()"
                                    style="padding: 10px 20px;">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 18px; vertical-align: middle; margin-right: 6px;">upload</span>
                                    Upload Icon
                                </button>
                                <input type="file" id="inpFaviconUpload" hidden accept="image/*"
                                    onchange="handleFaviconUpload(this)">

                                <button class="btn-neu" id="btnFetchBranding" onclick="fetchBrandingAssets()"
                                    style="padding: 10px 20px;">
                                    <span class="material-symbols-outlined"
                                        style="font-size: 18px; vertical-align: middle; margin-right: 6px;">language</span>
                                    Fetch from Website
                                </button>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-secondary); margin: 0;">
                                Upload a PNG, JPG, or ICO file (max 2MB). Or fetch automatically from your website URL.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 3b. BRAND PERSONALITY -->
                <h4 style="margin-bottom: 16px; font-size: 1rem;">
                    <span class="material-symbols-outlined"
                        style="vertical-align: middle; margin-right: 8px; font-size: 20px;">psychology</span>
                    Brand Personality
                </h4>

                <!-- Detect Button -->
                <div id="brandDetectSection" style="text-align: center; margin-bottom: 24px;">
                    <button id="btnDetectBrand" class="btn-neu primary" onclick="detectBrand()"
                        style="padding: 14px 32px; font-size: 1rem; font-weight: 600;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">auto_awesome</span>
                        Detect Brand Profile
                    </button>
                    <div id="brandDetectSpinner" style="display: none; margin-top: 12px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="color: var(--text-secondary); margin-top: 8px; font-size: 0.85rem;">Analyzing your
                            website content...</p>
                    </div>
                </div>

                <!-- Brand Profile Card -->
                <div id="brandProfileCard" style="display: none;">
                    <!-- AI Reasoning -->
                    <div id="brandReasoning" class="neu-card"
                        style="margin-bottom: 16px; padding: 12px 16px; background: rgba(79,70,229,0.05); border-left: 3px solid var(--primary);">
                        <span class="material-symbols-outlined"
                            style="vertical-align: middle; color: var(--primary); font-size: 18px;">psychology</span>
                        <span id="brandReasoningText" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                    </div>

                    <div class="two-col-grid" style="grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Left Column: Core Profile -->
                        <div>
                            <label>Industry</label>
                            <select id="inpBrandIndustry" class="input-neu" disabled>
                                <option value="E-Commerce">E-Commerce</option>
                                <option value="SaaS">SaaS</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Education">Education</option>
                                <option value="Finance">Finance</option>
                                <option value="Real Estate">Real Estate</option>
                                <option value="Marketing Agency">Marketing Agency</option>
                                <option value="Restaurant">Restaurant</option>
                                <option value="Legal">Legal</option>
                                <option value="Non-Profit">Non-Profit</option>
                                <option value="Technology">Technology</option>
                                <option value="Other">Other</option>
                            </select>

                            <label>Tone</label>
                            <select id="inpBrandTone" class="input-neu" disabled>
                                <option value="Professional">Professional</option>
                                <option value="Friendly">Friendly</option>
                                <option value="Casual">Casual</option>
                                <option value="Technical">Technical</option>
                                <option value="Sales-Oriented">Sales-Oriented</option>
                            </select>

                            <label>Primary Goal</label>
                            <select id="inpBrandGoal" class="input-neu" disabled>
                                <option value="Support">Support</option>
                                <option value="Lead Generation">Lead Generation</option>
                                <option value="Education">Education</option>
                                <option value="Sales">Sales</option>
                                <option value="Engagement">Engagement</option>
                            </select>

                            <label>Sales Intensity</label>
                            <div id="brandSalesIntensity" style="display: flex; gap: 10px; margin-bottom: 16px;">
                                <label class="radio-pill">
                                    <input type="radio" name="salesIntensity" value="Low" disabled>
                                    <span>Low</span>
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="salesIntensity" value="Medium" disabled>
                                    <span>Medium</span>
                                </label>
                                <label class="radio-pill">
                                    <input type="radio" name="salesIntensity" value="High" disabled>
                                    <span>High</span>
                                </label>
                            </div>
                        </div>

                        <!-- Right Column: Identity -->
                        <div>
                            <label>Assistant Role</label>
                            <input type="text" id="inpBrandRole" class="input-neu" placeholder="e.g. Product Advisor"
                                disabled>

                            <label>Assistant Name</label>
                            <input type="text" id="inpBrandName" class="input-neu" placeholder="e.g. Aria" disabled>

                            <label>Welcome Message</label>
                            <textarea id="inpBrandWelcome" class="input-neu" rows="2" placeholder="Hi! How can I help?"
                                disabled></textarea>
                        </div>
                    </div>

                    <!-- Override Toggle -->
                    <div style="margin-top: 16px; display: flex; align-items: center; gap: 10px;">
                        <label class="toggle-switch" style="margin-bottom: 0;">
                            <input type="checkbox" id="chkBrandOverride" onchange="toggleBrandOverride()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">I want to customize these
                            values</span>
                    </div>

                    <!-- Accept / Re-detect Actions -->
                    <div style="display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end;">
                        <button class="btn-neu" onclick="detectBrand()" style="font-size: 0.9rem;">
                            <span class="material-symbols-outlined"
                                style="vertical-align: middle; font-size: 18px;">refresh</span>
                            Re-detect
                        </button>
                        <button id="btnAcceptBrand" class="btn-neu primary" onclick="acceptBrandProfile()"
                            style="padding: 12px 28px; font-weight: 600;">
                            <span class="material-symbols-outlined" style="vertical-align: middle;">check_circle</span>
                            Accept Profile
                        </button>
                    </div>
                </div>

                <!-- Accepted Confirmation -->
                <div id="brandAcceptedBanner" class="neu-card"
                    style="display: none; text-align: center; padding: 16px; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.3);">
                    <span class="material-symbols-outlined" style="color: #22c55e; font-size: 32px;">verified</span>
                    <p style="margin: 8px 0 0; font-weight: 600; color: #22c55e;">Brand Profile Accepted</p>
                </div>

                <!-- Next Button (blocked until accepted) -->
                <div style="text-align: center; margin-top: 24px;">
                    <button id="btnStep3Next" class="btn-neu" disabled onclick="step3Next()"
                        style="padding: 14px 36px; font-weight: 600; font-size: 1rem; color: var(--primary); opacity: 0.5;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward</span>
                        Next: Test Chat
                    </button>
                </div>
            </div>

            <!-- STEP 4: TEST ASSISTANT -->
            <div id="step4" class="workflow-step">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="margin: 0;">
                        <span class="material-symbols-outlined"
                            style="vertical-align: middle; color: var(--primary);">science</span>
                        Test Assistant
                    </h3>
                    <div id="testCounter" class="test-counter">
                        <span class="material-symbols-outlined" style="font-size: 16px;">chat</span>
                        <span id="testCounterText">0 / 3</span>
                    </div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">
                    Test your assistant with real questions. Debug mode shows AI metadata on every response.
                    <strong>Minimum 3 interactions required to proceed.</strong>
                </p>

                <!-- Drift Warning Banner -->
                <div id="driftWarningBanner"
                    style="display: none; margin-bottom: 16px; padding: 12px 16px; background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.3); border-radius: 10px;">
                    <span class="material-symbols-outlined"
                        style="vertical-align: middle; color: #f87171; font-size: 20px;">warning</span>
                    <span id="driftWarningText"
                        style="font-size: 0.85rem; color: #f87171; font-weight: 600; margin-left: 6px;">
                        Critical drift detected — resolve before launching.
                    </span>
                </div>

                <!-- Debug Chat Simulator -->
                <div class="chat-preview"
                    style="height: 420px; margin-bottom: 16px; display: flex; flex-direction: column;">
                    <div class="chat-messages" id="testChatMessages" style="flex: 1; overflow-y: auto;">
                        <div class="msg-bot">
                            <span style="font-size: 0.9rem;">👋 I'm your assistant in <strong>debug mode</strong>. Ask
                                anything — you'll see confidence, sources, and gating results for each response.</span>
                        </div>
                    </div>
                    <div class="chat-input-area" style="padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.05);">
                        <input type="text" id="inpTestChat" placeholder="Ask a test question..." class="input-neu"
                            style="margin-bottom: 0;" onkeydown="if(event.key==='Enter') sendTestChat()">
                        <button id="btnSendTestChat" class="btn-neu primary" onclick="sendTestChat()"
                            style="padding: 10px 16px; min-width: auto;">
                            <span class="material-symbols-outlined" style="font-size: 20px;">send</span>
                        </button>
                    </div>
                </div>

                <!-- Feedback Summary -->
                <div id="feedbackSummary" style="display: none; margin-bottom: 16px; text-align: center;">
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">
                        Feedback:
                        <span id="feedbackUpCount" style="color: #22c55e; font-weight: 600;">0</span> 👍
                        <span id="feedbackDownCount"
                            style="color: #f87171; font-weight: 600; margin-left: 8px;">0</span> 👎
                    </span>
                </div>

                <!-- Next Button (gated) -->
                <div style="text-align: center; margin-top: 8px;">
                    <button id="btnStep4Next" class="btn-neu" disabled onclick="step4Next()"
                        style="padding: 14px 36px; font-weight: 600; font-size: 1rem; color: var(--primary); opacity: 0.5;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward</span>
                        Next: Widget Appearance
                    </button>
                </div>
            </div>

            <!-- STEP 5: WIDGET (Appearance) -->
            <div id="step5" class="workflow-step">
                <h3 style="margin-bottom: 20px;">Widget Appearance</h3>
                <div class="two-col-grid" style="gap: 30px;">
                    <div>
                        <label>Widget Title</label>
                        <input type="text" id="wizTitle" class="input-neu" placeholder="Support Bot">

                        <label>Primary Color</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="wizColor" value="#4f46e5"
                                style="height: 40px; width: 60px; border: none; cursor: pointer;">
                            <span id="wizColorVal">#4f46e5</span>
                        </div>
                    </div>
                    <div class="neu-card"
                        style="background: var(--bg-body); display: flex; align-items: center; justify-content: center; height: 200px;">
                        <p style="color: var(--text-tertiary);">Live Preview</p>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="saveWidgetStep()" class="btn-neu primary">Save & Continue</button>
                </div>
            </div>

            <!-- STEP 6: LAUNCH -->
            <div id="step6" class="workflow-step">
                <div id="launchPreView" style="text-align: center; padding: 30px 20px;">
                    <span class="material-symbols-outlined"
                        style="font-size: 56px; color: var(--primary); margin-bottom: 12px;">rocket_launch</span>
                    <h2 style="margin-bottom: 4px;">Pre-Launch Validation</h2>
                    <p style="color: var(--text-secondary); max-width: 420px; margin: 0 auto 24px; font-size: 0.9rem;">
                        All checks must pass before you can launch. This action is <strong>irreversible</strong>.
                    </p>

                    <!-- Dynamic Checklist -->
                    <div id="launchChecklist" class="neu-card"
                        style="max-width: 400px; margin: 0 auto 24px; text-align: left;">
                        <div class="launch-check-row" id="check_coverage">
                            <span class="check-icon material-symbols-outlined">hourglass_empty</span>
                            <div>
                                <div class="check-label">Content Coverage</div>
                                <div class="check-detail" id="detail_coverage">Checking...</div>
                            </div>
                        </div>
                        <div class="launch-check-row" id="check_branding">
                            <span class="check-icon material-symbols-outlined">hourglass_empty</span>
                            <div>
                                <div class="check-label">Brand Alignment</div>
                                <div class="check-detail" id="detail_branding">Checking...</div>
                            </div>
                        </div>
                        <div class="launch-check-row" id="check_testing">
                            <span class="check-icon material-symbols-outlined">hourglass_empty</span>
                            <div>
                                <div class="check-label">Test Interactions</div>
                                <div class="check-detail" id="detail_testing">Checking...</div>
                            </div>
                        </div>
                        <div class="launch-check-row" id="check_confidence">
                            <span class="check-icon material-symbols-outlined">hourglass_empty</span>
                            <div>
                                <div class="check-label">Confidence Policy</div>
                                <div class="check-detail" id="detail_confidence">Checking...</div>
                            </div>
                        </div>
                        <div class="launch-check-row" id="check_drift">
                            <span class="check-icon material-symbols-outlined">hourglass_empty</span>
                            <div>
                                <div class="check-label">Drift Status</div>
                                <div class="check-detail" id="detail_drift">Checking...</div>
                            </div>
                        </div>
                    </div>

                    <button id="btnLaunch" class="btn-neu primary" disabled
                        style="font-size: 1.15rem; padding: 16px 48px; opacity: 0.5;" onclick="launchConnection()">
                        <span class="material-symbols-outlined"
                            style="vertical-align: middle; margin-right: 6px;">rocket_launch</span>
                        Launch Chatbot
                    </button>
                </div>

                <!-- Post-Launch Success (hidden initially) -->
                <div id="launchSuccessView" style="display: none; text-align: center; padding: 40px 20px;">
                    <span class="material-symbols-outlined"
                        style="font-size: 72px; color: #22c55e; margin-bottom: 16px;">check_circle</span>
                    <h2 style="color: #22c55e; margin-bottom: 8px;">🚀 Chatbot Launched!</h2>
                    <p id="launchTimestamp"
                        style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 24px;">
                    </p>
                    <div class="neu-card" style="max-width: 400px; margin: 0 auto 24px; text-align: left;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <span class="material-symbols-outlined" style="color: #22c55e; font-size: 18px;">lock</span>
                            <span style="font-weight: 600;">Wizard locked</span>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin: 0;">
                            Your chatbot is now live and serving production traffic.
                            Use the <strong>Edit</strong> panel to make changes.
                        </p>
                    </div>
                    <button class="btn-neu" onclick="closeWorkflow(); loadConnections();" style="padding: 12px 32px;">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">dashboard</span>
                        Back to Dashboard
                    </button>
                </div>
            </div>

        </div> <!-- End modal-body -->
    </div>
    </div>




    <!-- EDITOR VIEW -->
    <div id="editorView" style="display: none; padding: 30px; max-width: 1400px; margin: 0 auto;">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <button class="btn-icon" onclick="closeEditor()">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <div class="avatar-circle" id="editorAvatar" style="width: 48px; height: 48px; font-size: 1.5rem;">B
                </div>
                <div>
                    <h1 id="editorBotName" style="margin: 0; font-size: 1.5rem;">Bot Name</h1>
                    <a id="editorBotLink" href="#" target="_blank"
                        style="color: var(--text-secondary); font-size: 0.9rem; text-decoration: none; display: flex; align-items: center; gap: 4px;">
                        <span class="material-symbols-outlined" style="font-size: 16px;">link</span>
                        <span id="editorBotUrl">github.com/portfolio-bot</span>
                    </a>
                </div>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-neu" onclick="syncBot()" id="btnSyncBot">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">sync</span>
                    Sync Bot
                </button>
                <button class="btn-neu primary" onclick="publishChanges()" id="btnPublishChanges">
                    Publish Changes
                </button>
            </div>
        </div>

        <!-- Editor Grid -->
        <div class="editor-grid">
            <!-- Col 1: Business Details -->
            <div class="editor-card">
                <div class="card-header-accent"></div>
                <h3>Business Details</h3>

                <label>Assistant Name</label>
                <input type="text" id="editName" class="input-neu">

                <label>System Prompt (Instructions)</label>
                <textarea id="editPrompt" class="input-neu" rows="8"
                    style="resize: vertical; min-height: 150px; font-family: sans-serif;"></textarea>

                <div style="text-align: right; margin-top: 16px;">
                    <button class="btn-neu" onclick="saveConnectionChanges()" style="width:100%">
                        <span class="material-symbols-outlined" style="vertical-align: middle;">save</span>
                        Save Tunings
                    </button>
                </div>
            </div>

            <!-- Col 2: AI Behavior -->
            <div class="editor-card">
                <div class="card-header-accent blue"></div>
                <h3>AI Behavior</h3>

                <label>Assistant Tone</label>
                <select id="editTone" class="input-neu">
                    <option value="Professional">Professional & Friendly</option>
                    <option value="Casual">Casual & Witty</option>
                    <option value="Technical">Technical & Precise</option>
                    <option value="Sales">Sales-Oriented</option>
                </select>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label>Max Tokens</label>
                        <input type="number" id="editTokens" class="input-neu">
                    </div>
                    <div>
                        <label>Confidence</label>
                        <input type="number" id="editConfidence" class="input-neu" step="0.1" max="1.0" min="0.1">
                    </div>
                </div>

                <div class="info-box-blue">
                    Adjusting confidence limits how much similarity is required before the AI attempts to answer.
                </div>

                <div style="text-align: center; margin-top: auto;">
                    <button class="btn-neu" onclick="saveConnectionChanges()" style="width: 100%;">
                        Update Behavior
                    </button>
                </div>
            </div>

            <!-- Col 3: Test Interaction -->
            <div class="editor-card" style="grid-row: span 2;">
                <div class="card-header-accent red"></div>
                <h3>Test Interaction</h3>

                <div id="editorChatContainer"
                    style="flex: 1; display: flex; flex-direction: column; height: 100%; min-height: 500px;">
                    <div id="editorChatMessages" class="chat-messages"
                        style="flex: 1; overflow-y: auto; padding: 10px; background: transparent;">
                        <div class="msg-bot">
                            <span style="font-size:0.9rem">Hello! I'm your Portfolio Assistant. How can I help you
                                today?</span>
                        </div>
                    </div>

                    <div class="chat-input-area"
                        style="background: white; padding: 10px; border-radius: 12px; margin-top: 10px;">
                        <input type="text" id="inpEditorChat" placeholder="Type a message..." class="input-neu"
                            style="margin-bottom:0; border:none;" onkeydown="if(event.key==='Enter') sendEditorChat()">
                        <button class="btn-icon" onclick="sendEditorChat()">
                            <span class="material-symbols-outlined" style="color: var(--primary);">send</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Row 2: Knowledge Base -->
            <div class="editor-card" style="grid-column: span 2;">
                <div class="card-header-accent purple"></div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Knowledge Base</h3>
                    <button class="btn-neu small" onclick="triggerScan()">
                        <span class="material-symbols-outlined" style="font-size: 16px;">refresh</span> Re-Scan Website
                    </button>
                </div>

                <div id="editorKnowledgeList"
                    style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: var(--bg-body); border-radius: 12px; margin-top: 16px;">
                    <div style="text-align: center; color: var(--text-tertiary);">
                        <span class="material-symbols-outlined"
                            style="font-size: 48px; opacity: 0.5;">inventory_2</span>
                        <p>Knowledge base is empty.</p>
                        <button class="btn-link">Add Source</button>
                    </div>
                </div>
            </div>

            <!-- Missed Questions -->
            <!-- Note: Depending on row span, this might need to change position. Currently relying on Grid auto-placement. -->
        </div>
    </div>


    <!-- MONITOR DASHBOARD OVERLAY -->
    <div id="monitorOverlay" class="monitor-overlay" style="display: none;">
        <div class="monitor-panel neu-card">
            <div class="monitor-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="material-symbols-outlined"
                        style="font-size: 28px; color: var(--primary);">monitoring</span>
                    <div>
                        <h2 id="monitorTitle" style="margin: 0; font-size: 1.2rem;">Monitor Dashboard</h2>
                        <span id="monitorLaunchDate" style="font-size: 0.78rem; color: var(--text-secondary);"></span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="monitorRiskBadge" class="risk-badge low">
                        <span class="material-symbols-outlined" style="font-size: 14px;">shield</span>
                        <span id="monitorRiskText">LOW</span>
                    </div>
                    <button class="btn-icon" onclick="closeMonitor()" style="font-size: 20px;">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>

            <!-- Red Alert Panel -->
            <div id="monitorAlertPanel" class="monitor-alert" style="display: none;">
                <span class="material-symbols-outlined" style="font-size: 20px;">error</span>
                <div>
                    <strong>Attention Required</strong>
                    <div id="monitorAlertText" style="font-size: 0.82rem; margin-top: 2px;"></div>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div class="monitor-grid">
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">forum</span>
                    <div class="metric-val" id="monConversations">—</div>
                    <div class="metric-label">Conversations</div>
                </div>
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">verified</span>
                    <div class="metric-val" id="monConfidence">—</div>
                    <div class="metric-label">Avg Confidence</div>
                </div>
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">pie_chart</span>
                    <div class="metric-val" id="monCoverage">—</div>
                    <div class="metric-label">Coverage</div>
                </div>
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">warning</span>
                    <div class="metric-val" id="monDrift">—</div>
                    <div class="metric-label">Drift Alerts</div>
                </div>
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">favorite</span>
                    <div class="metric-val" id="monHealth">—</div>
                    <div class="metric-label">Health Score</div>
                </div>
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">palette</span>
                    <div class="metric-val" id="monBrand">—</div>
                    <div class="metric-label">Brand Alignment</div>
                </div>
                <div class="monitor-metric">
                    <span class="material-symbols-outlined metric-icon">pending_actions</span>
                    <div class="metric-val" id="monPending">—</div>
                    <div class="metric-label">Extraction Pending</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="monitor-actions">
                <button class="btn-neu" onclick="recalcCoverage()" id="btnRecalcCoverage">
                    <span class="material-symbols-outlined"
                        style="font-size: 18px; vertical-align: middle;">refresh</span>
                    Recalculate Coverage
                </button>
                <button class="btn-neu" onclick="reanalyzeBrand()" id="btnReanalyzeBrand">
                    <span class="material-symbols-outlined"
                        style="font-size: 18px; vertical-align: middle;">auto_fix_high</span>
                    Reanalyze Brand
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast"
        style="position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; background: var(--bg-body); box-shadow: var(--shadow-light); border-radius: 50px; transform: translateY(100px); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; font-weight: 600;">
        Notification
    </div>

    <script src="/admin.js"></script>
</body>

</html>